---
title: "DroughtNet data cleaning"
output: html_notebook
---

load the Durin data set

```{r}
library(tidyverse)
library(dplyr)
library(readr)
library(here)
#install.packages("here")


#part 1 error identification
data <- read_csv(here("output/DURIN_clean.csv"), guess_max = Inf) # guess_max = Inf' helps in correctly guessing the column types for all rows.
view(data)
```
filter to DroughtNet
```{r}

# Filter the 'data' dataframe for specific conditions
droughtnet_data <- data %>%
  # Select rows where ageClass is "Pioneer" or "Mature", and DroughtTrt is "Amb (0)" or "Ext (90)"
  # Also include rows where 'project' column contains "Field - Traits"
  filter(
    (ageClass == "Pioneer" | ageClass == "Mature") &
    (DroughtTrt == "Amb (0)" | DroughtTrt == "Ext (90)") &
    grepl("Field - Traits", project)
  )

view(droughtnet_data) # Display the filtered dataset

```

plant count per site

```{r}
# Count the number of plants per site
# create a summary of the "droughtnet_data" dataset
(plant_count_per_site <- droughtnet_data %>%
  # Group the data by "siteID"
  group_by(siteID) %>%
  # Summarise the data to count the number of rows (plants) in each site
  summarise(plant_count = n()))

```

```{r}
# Calculate the number of unique species per plot in each site
(species_count_per_plot_site <- droughtnet_data %>%
  # Group the data by 'siteID' and 'DroughNet_plotID'.
  group_by(siteID, DroughNet_plotID) %>%
  # Summarize the data to count the distinct number of species in each group.
  summarise(unique_species_count = n_distinct(species)))
# Display the resulting data frame.
view(species_count_per_plot_site)


# Calculate the total number of leaves for each species in both sites
(count_per_species <- droughtnet_data %>%
  # Group the data by 'siteID' and 'species'.
  group_by(siteID, species) %>%
  # Summarize the data to calculate the sum of 'leaf_nr', excluding NA values.
  summarise(total_leaves = sum(leaf_nr, na.rm = TRUE)))



```

```{r}
# Check for missing Drought Treatment
# Identify any missing "DroughtTrt" (Drought Treatment) values in the "droughtnet_data" dataset.
# Extract envelope_ID values with missing DroughtTrt
(envelopes_missing_droughttrt <- droughtnet_data %>%
  # Filter the dataset to include only rows where "DroughtTrt" is NA (Not Available or missing).
  filter(is.na(DroughtTrt)) %>%
  # Extract the 'envelope_ID' column from the filtered data.
  pull(envelope_ID) %>%
  # Get unique values from the 'envelope_ID' column to avoid duplicates.
  unique())
# 0 missing drought treatment


# verify whether each DroughtNet plot ID within a site has a unique treatment.
# Group data by DroughNet_plotID and siteID, then count unique DroughtTrt values
treatment_uniqueness <- droughtnet_data %>%
  # Group the dataset by "DroughNet_plotID" and "siteID".
  group_by(DroughNet_plotID, siteID) %>%
  # Summarize the data in each group to count the distinct number of DroughtTrt (Drought Treatment) values.
  summarise(unique_treatments = n_distinct(DroughtTrt)) 


# Check if any group has more than one unique treatment
(non_unique_treatments <- treatment_uniqueness %>%
  # Filter to keep only those groups where the count of unique treatments is greater than one.
  filter(unique_treatments > 1))

# specific findings: 
# Plots 1.2, 1.3, 2.2 in Tjøtta and plot 2.1 in Lygra have more than one unique treatment.

# Extract rows from the droughtnet dataset based on non-unique treatments
# Creating "non_unique_treatment_rows" data frame.
non_unique_treatment_rows <- droughtnet_data %>%
  # Perform a semi-join with the "non_unique_treatments" data frame. This join includes rows from "droughtnet_data"
  # that have matching "DroughNet_plotID" and "siteID" in 'non_unique_treatments'.
  semi_join(non_unique_treatments, by = c("DroughNet_plotID", "siteID")) %>%
  # Select specific columns of interest: envelope_ID, species, DroughNet_plotID, DroughtTrt, and siteID.
  select(envelope_ID, species, DroughNet_plotID, DroughtTrt, siteID)

view(non_unique_treatment_rows) # Display the extracted rows


# Filter for only Lygra's 2.1 plot from non_unique_treatment_rows
# Create 'lygra_2_1_rows' data frame.
lygra_2_1_rows <- non_unique_treatment_rows %>%
    # Apply a filter to select only rows where "siteID" is "Lygra" and "DroughNet_plotID" is "2.1".
    filter(siteID == "Lygra" & DroughNet_plotID == "2.1")

view(lygra_2_1_rows) # Display the filtered data
# AEG7270 has Amb(0) treatment, the rest are extreme, registered in RD4


# Filter for only Tjøtta's 2.2 plot from non_unique_treatment_rows
# Create Tjøtta_2_2_rows data frame.
tjøtta_2_2_rows <- non_unique_treatment_rows %>%
    # Apply a filter to select only rows where "siteID" is "Tjøtta" and "DroughNet_plotID" is "2.2".
    filter(siteID == "Tjøtta" & DroughNet_plotID == "2.2")

view(tjøtta_2_2_rows) # Display the filtered data
# EEN3300 has Amb(0) treatment, the rest are extreme, REGISTERED IN RD4


# Filter for only Tjøtta's 1.3 plot from non_unique_treatment_rows
# Creating "Tjøtta_1_3_rows" data frame.
tjøtta_1_3_rows <- non_unique_treatment_rows %>%
    # Apply a filter to select only rows where 'siteID' is "Tjøtta" and 'DroughNet_plotID' is "1.3".
    filter(siteID == "Tjøtta" & DroughNet_plotID == "1.3")

view(tjøtta_1_3_rows) # Display the filtered data
#plot 1.3 appears in both pioneer and mature stages.
#verified same plot number in pioneer and mature


# Filter for only Tjøtta's 1.2 plot from non_unique_treatment_rows
# Creating 'tjøtta_1_2_rows' data frame.
tjøtta_1_2_rows <- non_unique_treatment_rows %>%
    # Apply a filter to select only rows where 'siteID' is "Tjøtta" and 'DroughNet_plotID' is "1.2".
    filter(siteID == "Tjøtta" & DroughNet_plotID == "1.2")

view(tjøtta_1_2_rows) # Display the filtered data
# check again later, seems 1.2 is both in pioneer and mature hence more than 1 unique treatment
# verified, same plot number in both age classes
```

```{r}
# Rows missing age class in the dataset
# find and display rows in "droughtnet_data" where the "ageClass" information is missing.
ageClass_missing <- droughtnet_data %>%
  # Apply a filter to select only rows where the "ageClass" value is missing (NA).
  filter(is.na(ageClass)) %>%
  # Select only the "envelope_ID" and "ageClass" columns for the filtered data.
  select(envelope_ID, ageClass)

view(ageClass_missing) # Display the filtered data
#no envelope ids with missing ageClass
```


```{r}
# Checking for exceeding envelope count per plant
selected_month <- "September"  # To avoid counting Calluna sampled in June.
selected_site_for_calluna <- "Lygra"  # Specific site for Calluna vulgaris.

envelope_details <- droughtnet_data %>%
  # Apply filter conditions for species and adding specific conditions for Calluna vulgaris.
  filter(
    # Include specific species from Lygra and Tjøtta sites, and adding a condition for Calluna vulgaris in Lygra in September.
    (species %in% c("Vaccinium myrtillus", "Empetrum nigrum", "Vaccinium vitis_idaea") & siteID %in% c("Lygra", "Tjøtta")) |
    (species == "Calluna vulgaris" & siteID == selected_site_for_calluna & month == selected_month)
  ) %>%
  # Group by multiple factors including species, site, month, plot, plant number, and age class.
  group_by(species, siteID, month, DroughNet_plotID, plant_nr, ageClass) %>%
  # Summarise the data to calculate the count of distinct envelope IDs for each group and listing the envelope IDs.
  summarise(
    envelope_count = n_distinct(envelope_ID),
    envelope_ids = list(envelope_ID),
    .groups = 'drop'  # Drop the group-wise operation after summarisation.
  ) %>%
  # Add a column "expected_count" to specify the expected envelope count for each species.
  mutate(expected_count = case_when(
    species == "Vaccinium myrtillus" ~ 3,  # Expected count for Vaccinium myrtillus.
    species %in% c("Vaccinium vitis_idaea", "Empetrum nigrum", "Calluna vulgaris") ~ 6,  # Expected count for other species.
    TRUE ~ NA_integer_  # NA for species not specified.
  ))
# outcome of the operation:
# no instances where the envelope count exceeds the expected count
```

checking for multiple heights in Calluna vulgaris specifically Lygra
    ```{r}
# Filter for Calluna vulgaris sampled in September
calluna_heights_and_envelopes <- droughtnet_data %>%
  # Apply a filter for Calluna vulgaris in September at the Lygra site.
  filter(species == "Calluna vulgaris", siteID == "Lygra", month == 9) %>%  
  # Group the data by site, plot, plant number, and plant height.
  group_by(siteID, DroughNet_plotID, plant_nr, plant_height) %>%
  # Summarise the data to count the number of records (envelope count) and listing the envelope IDs for each group.
  summarise(
    envelope_count = n(),
    envelope_ids = list(envelope_ID),
    .groups = 'drop'  # Ensures that the resulting tibble is ungrouped after summarisation.
  )

view(calluna_heights_and_envelopes) # Display the summarized data

# findings:
# no instances of multiple heights in the drought conditions.
    ```
checking calluna short or long shoot type
```{r}
# Get unique values of calluna_shoot_type for "Calluna vulgaris" in "Lygra"

unique_values <- droughtnet_data %>%
  # Apply a filter for the species "Calluna vulgaris" in the Lygra site.
  filter(species == "Calluna vulgaris", siteID == "Lygra") %>%
  # Extract the "calluna_shoot_type" column.
  pull(calluna_shoot_type) %>%
  # Get unique values from the 'calluna_shoot_type' column.
  unique()

view(unique_values) # Display the unique values

# Filter Calluna with missing shoot type
# calluna_shoot_type is missing or not within the specified categories ("Short", "Long").
# Create "missing_shoot_type" data frame.
missing_shoot_type <- droughtnet_data %>%
  # Apply a filter for the species "Calluna vulgaris" sampled in September.
  filter(species == "Calluna vulgaris", month == "September") %>%
  # Group the data by envelope ID.
  group_by(envelope_ID) %>%
  # Filter to include only those rows where "calluna_shoot_type" is missing or not in the specified categories.
  filter(is.na(calluna_shoot_type) | !(calluna_shoot_type %in% c("Short", "Long")))

View(missing_shoot_type %>% select(envelope_ID, calluna_shoot_type)) # Display the filtered data with specific columns

# 0 CV missing shoot type

```


```{r}
# Check missing leaf age in Vaccinium Vitis-idaea and Empetrum nigrum
# Creating "missing_leaf_age" data frame.
missing_leaf_age <- droughtnet_data %>%
  # Apply a filter for the species "Empetrum nigrum" and "Vaccinium vitis-idaea".
  filter(species %in% c("Empetrum nigrum", "Vaccinium vitis-idaea")) %>%  
  # Filter out rows where the "leaf_age" column has missing values.
  filter(is.na(leaf_age))

view(missing_leaf_age %>% select(envelope_ID, species, leaf_age)) # Display  

# findings:
# no entries with missing leaf ages for these two species.
```


#part 2 solutions
```{r}
# Update drought treatment
# Update "droughtnet_data" with new drought treatment values.
droughtnet_data <- droughtnet_data %>%
  # Use mutate to create or transform the "DroughtTrt" column.
  mutate(
    DroughtTrt = case_when(
      # Set "DroughtTrt" to "Ext(90)" if "envelope_ID" is "EEN3300".
      envelope_ID == "EEN3300" ~ "Ext(90)",
      # Setting "DroughtTrt" to "Ext(90)" if "envelope_ID" is "AEG7270".
      envelope_ID == "AEG7270" ~ "Ext(90)",
      # Keep existing values of "DroughtTrt" for all other cases.
      TRUE ~ DroughtTrt
    )
  )

# The mutate function with case_when is used to conditionally modify the "DroughtTrt" field.
# For all other rows, the existing value of "DroughtTrt" is retained.

```

