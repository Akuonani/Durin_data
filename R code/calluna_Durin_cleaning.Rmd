---
title: "Calluna data cleaning"
output: html_notebook
---


Load the Data.,

```{r}
library(tidyverse)
library(dplyr)
library(readr)

#part 1 identify errors in the data set

data <- read_csv("C:/Users/User/Desktop/Durin_data/output/DURIN_clean.csv", guess_max = Inf)
View(data)

```
Filter data for species "Calluna vulgaris"
```{r}
calluna_data <- filter(data, species == "Calluna vulgaris" & siteID %in% c("Lygra", "Sogndal", "Senja") & 
         grepl("Field - Traits", project))
view(calluna_data)
 ```
# Count the number of "Calluna vulgaris" plants per site
(plant_count_per_site <- calluna_data %>%
  filter(siteID %in% c("Lygra", "Sogndal", "Senja")) %>%
  group_by(siteID) %>%
  summarise(count = n()))
```

species count (number of Calluna plants) per plot
```{r}
count_per_plot <- calluna_data %>%
  group_by(DURIN_plot) %>%
  summarise(count = n())
view(count_per_plot)

count_per_plot <- calluna_data %>%
  group_by(DroughNet_plotID) %>%
  summarise(count = n())
view(count_per_plot)
```

no plots assigned
```{r}
# Count plants with no plots assigned
no_plot_count <- calluna_data %>%
  filter(is.na(DURIN_plot) & is.na(DroughNet_plotID)) %>%
  summarise(count = n()) %>%
  mutate(plot_type = "No Plot Assigned", plot = "No Plot Assigned")

# Combine the results
combined_results <- bind_rows(count_durin_plot, count_droughnet_plot, no_plot_count)

 view(combined_results)

# Filter out all entries where both DURIN_plot and DroughNet_plotID are not assigned
no_plots_assigned_by_envelope <- calluna_data %>%
  filter(is.na(DURIN_plot) & is.na(DroughNet_plotID)) %>%
  select(envelope_ID, siteID, DURIN_plot, DroughNet_plotID)

view(no_plots_assigned_by_envelope)
```
 # no  entries without plot assigned

```{r}
envelope_details <- calluna_data %>%
  filter(month == "September") %>%
  group_by(siteID, DURIN_plot, DroughNet_plotID, plant_nr) %>%
  summarise(
    envelope_count = n_distinct(envelope_ID),
    envelope_ids = list(envelope_ID),
    .groups = 'drop' # Drop grouping
  )

# Filter for cases where the envelope count is greater than 6
excessive_envelope_details <- envelope_details %>%
  filter(envelope_count > 6)
View(excessive_envelope_details) 

# Expand the envelope_ID column to display all the barcodes
expanded_envelopeids <- excessive_envelope_details %>%
  unnest(envelope_ids)
View(expanded_envelopeids) 
# found  plants extras, not recorded yet


envelope_details <- calluna_data %>%
  filter(month == "September") %>%
  group_by(siteID, DURIN_plot, DroughNet_plotID, plant_nr) %>%
  summarise(
    envelope_count = n_distinct(envelope_ID),
    envelope_ids = list(envelope_ID),
    .groups = 'drop' # Drop grouping
  )

# Filter for cases where the envelope count is < 6
few_envelope_details <- envelope_details %>%
  filter(envelope_count < 6)
View(less_envelope_details) 

# Expand the envelope_ID column to display all the barcodes
expanded_envelope_ids <- few_envelope_details %>%
  unnest(envelope_ids)
View(expanded_envelope_ids)
```


check multiple heights for calluna vulgaris
```{r}
  # Filter for Calluna vulgaris, exclude NA in DURIN_plot, group by plant_nr and plant_height, and gather envelope_IDs
calluna_heights_and_envelopes <- calluna_data %>%
  filter(!is.na(DURIN_plot)) %>%  # Exclude rows where DURIN_plot is NA
  group_by(siteID, DURIN_plot, plant_nr, plant_height) %>%
  summarise(
    envelope_count = n(),
    envelope_ids = list(envelope_ID)
  ) %>%
  ungroup()  # Make sure to ungroup after summarise

# Filter to only include rows where there's more than one height for the same plant
multiple_heights_calluna <- calluna_heights_and_envelopes %>%
  group_by(siteID, DURIN_plot, plant_nr) %>%
  filter(n() > 1) %>%
  ungroup()

# If you want to view this in R console
view(multiple_heights_calluna)

# Expand the envelope_ID column to display all the barcodes
expanded_calluna <- multiple_heights_calluna %>%
  unnest(envelope_ids)

view(expanded_calluna)
#found a good number of them with multiple heights
#solution- to crosscheck with field notes- registered in RD4 CHEKS
```

plants with missing heights
```{r}
# Filter data for the three sites and missing heights
calluna_missing_heights <- calluna_data %>%
  group_by(envelope_ID) %>%
  filter(siteID %in% c("Lygra", "Sogndal", "Senja"), is.na(plant_height))

# Display the plants with missing heights
view(calluna_missing_heights %>% select(envelope_ID, siteID, DURIN_plot, DroughNet_plotID, plant_height))
```
#no calluna with missing height


missing shoot type
```{r}
missing_shoot_type <- calluna_data %>%
  filter(month == "September") %>% #only calluna sampled in september had shoot type
  group_by(envelope_ID) %>%
  filter(is.na(calluna_shoot_type) | !calluna_shoot_type %in% c("Short", "Long"))

view(missing_shoot_type %>% select(envelope_ID, calluna_shoot_type))

#found 3 entries with missing shoot type
#To cross check with envelopes- already REGISTERED in rd4 checks
```

```{r}

# Filter for missing plant numbers
missing_plant_numbers <- calluna_data %>%
  filter(is.na(plant_nr))

# View the results
View(missing_plant_numbers)
#found 3 missing plant numbers
#check envelopes for plot 5, 3 and 2 to check the missing plant numbers


# Filter the data for DURIN_plot being exactly 'SE_F_CV_5' or 'SE_F_CV_3',SO_F_CV_2 to trace plant numbers for NAS
filtered_data <- calluna_data %>%
  filter(DURIN_plot == "SE_F_CV_5" | DURIN_plot == "SE_O_CV_3" | DURIN_plot == "SO_F_CV_2") %>%
  select(DURIN_plot, envelope_ID, habitat, plant_nr,leaf_nr, calluna_shoot_type, plant_height)

View(filtered_data)


```




#part 2 correct errors
# solution for multiple heights
```{r}
# load  the correct heights for calluna from the field notes 
Plant_height_for_calluna <- read_csv("C:/Users/User/Desktop/Durin_data/output/Plant_height_for_calluna.csv")
View(Plant_height_for_calluna)


Plant_height_for_calluna <- Plant_height_for_calluna %>% #rename plant height
  rename(correct_height = plant_height)


# Perform the merge on both plant_nr and plot ids
merged_data <- merge(calluna_data, Plant_height_for_calluna[c("DURIN_plot", "DroughNet_plotID", "plant_nr", "correct_height")],
                     by = c("DURIN_plot", "DroughNet_plotID", "plant_nr"), 
                     all.x = TRUE)

# Replace the original height with the correct height
merged_data$plant_height <- ifelse(is.na(merged_data$correct_height), 
                                   merged_data$plant_height, 
                                   merged_data$correct_height)

# Drop the correct_height column if it's no longer needed
merged_data <- merged_data[ , !(names(merged_data) %in% c("correct_height"))]
view(merged_data)
#multiple heights have been corrected.


#check if the issue of multiple heights still persists
# Check for multiple heights in merged data
multiple_heights <- merged_data %>%
  group_by(plant_nr, DURIN_plot, DroughNet_plotID) %>%
  summarise(unique_heights = n_distinct(plant_height), .groups = 'drop') %>%
  filter(unique_heights > 1)


View(multiple_heights)
#no plants with multiple heights

```
 
# solution for those missing calluna shoot type
```{r}

# correct entry
calluna_data <- calluna_data %>%
  mutate(calluna_shoot_type = ifelse(envelope_ID == "JVA1966" & (is.na(calluna_shoot_type) | calluna_shoot_type == ""), 
                                     "Long", calluna_shoot_type))

updated_entries <- filter(calluna_data, envelope_ID == "JVA1966") # check if updated
View(updated_entries)


#set entries with missing shoot type to NA
# set missing or incorrect shoot types to NA for September samples
calluna_data <- calluna_data %>%
  mutate(calluna_shoot_type = ifelse(month == "September" & 
                                     (is.na(calluna_shoot_type) | 
                                      !calluna_shoot_type %in% c("Short", "Long")), 
                                     NA, calluna_shoot_type))

# Verify that the missing shoot types have been set to NA
missing_shoot_type_corrected <- calluna_data %>%
  filter(month == "September") %>%
  group_by(envelope_ID) %>%
  filter(is.na(calluna_shoot_type) | !calluna_shoot_type %in% c("Short", "Long"))

View(missing_shoot_type_corrected %>% select(envelope_ID, calluna_shoot_type))

```
 
# solution for extra leaves per plant
```{r}
# Create a data frame with the mappings
plot_update <- data.frame(
  envelope_ID = c("JSB2142", "JRJ3443", "EZW2868", "FAY0434", "FCR0014", "FCU0944"), # envelope ids with wrong plot numbers
  new_DURIN_plot = c("Ly_F_CV_4", "Ly_F_CV_3", "Se_F_CV_2", "Se_F_CV_2", "Se_O_CV_4", "Se_O_CV_1"),  # New DURIN_plot numbers as strings
  new_plot_nr = c(4, 3, 2, 2, 4, 1)  # New plot_nr numbers
)

# Merge the updates with the original data
calluna_data <- calluna_data %>%
  left_join(plot_update, by = "envelope_ID") %>%
  mutate(
    DURIN_plot = ifelse(!is.na(new_DURIN_plot), new_DURIN_plot, DURIN_plot),
    plotNR = ifelse(!is.na(new_plot_nr), new_plot_nr, plotNR)
  ) %>%
  # Remove the helper columns after the update
  select(-new_DURIN_plot, -new_plot_nr)

# Check the updated entriees
updated_entries <- filter(calluna_data, envelope_ID %in% calluna_data$envelope_ID)
View(updated_entries)

# update site ID
#correct site ID for FIV6929
calluna_data <- calluna_data %>%
  mutate(siteID = ifelse(envelope_ID == "FIV6929", "Sogndal", siteID))

# check the updated entry
updated_entry <- filter(calluna_data, envelope_ID == "FIV6929")
View(updated_entry)

# update plant number
# Update the plant_number for"JUC3901" to 2
calluna_data <- calluna_data %>%
  mutate(plant_number = ifelse(envelope_ID == "JUC3901", 2, plant_nr))

# Check the updated entry to confirm the change
updated_entry <- filter(calluna_data, envelope_ID == "JUC3901")
View(updated_entry)

```













